<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mfumo wa Kuhifadhi Picha wa Duara</title>
     <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- CSS (Mitindo) -->
    <style>
        /* Mitindo Maalum kwa ajili ya Duara na Kuhariri */
        .profile-photo {
            width: 150px;       
            height: 150px;      
            border-radius: 50%; /* HII NDIYO HUFANYA IWE DUARA */
            object-fit: cover;  
            border: 5px solid #3b82f6; 
            transition: all 0.3s ease-in-out;
        }
        .profile-photo-loading {
            filter: blur(5px);
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-start justify-center p-4">

    <div class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 mt-10">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">Hifadhi Picha Yako ya Wasifu</h1>
        <p class="text-sm text-gray-500 mb-6 text-center">Data ya picha inahifadhiwa kwenye Firestore (Base64)</p>
        
        <!-- SEHEMU YA MTUMIAJI NA HALI YA DATA -->
        <div class="text-center mb-8 border-b pb-4">
            <p id="userIdDisplay" class="text-xs text-gray-700 font-mono bg-gray-100 p-2 rounded-lg inline-block break-all">Kupata Mtumiaji...</p>
            <p id="statusMessage" class="mt-2 text-sm font-semibold text-green-600"></p>
        </div>

        <!-- SEHEMU YA KUONYESHA PICHA -->
        <div class="mb-8 text-center">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Picha Yako ya Duara</h3>
            
            <img 
                id="profileImage" 
                src="https://placehold.co/150x150/dbeafe/1e40af?text=Pakia+Picha" 
                alt="Picha ya Wasifu" 
                class="profile-photo mx-auto transition duration-300 ease-in-out">
            
            <p id="fileNameDisplay" class="text-sm text-gray-500 mt-3"></p>
        </div>

        <!-- SEHEMU YA KU-UPLOAD (Fomu) -->
        <form id="uploadForm" class="border-t pt-6">
            <label for="photoInput" class="block text-sm font-medium text-gray-700 mb-2 text-left">
                Chagua Picha Mpya ya Wasifu
            </label>
            
            <input 
                type="file" 
                id="photoInput" 
                name="profile_image" 
                accept="image/jpeg, image/png, image/webp" 
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                required>

            <button 
                type="submit" 
                id="saveButton"
                class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                Hifadhi Picha Kwenye Database
            </button>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables Zilizotolewa na Mazingira ya Canvas (Mandatory)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        
        const profileImage = document.getElementById('profileImage');
        const statusMessage = document.getElementById('statusMessage');
        const saveButton = document.getElementById('saveButton');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const photoInput = document.getElementById('photoInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        
        // ------------------------------------------
        // 1. KUANZISHA FIREBASE NA KUTHIBITISHA MTUMIAJI
        // ------------------------------------------

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase: Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase: Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    statusMessage.textContent = "Kosa la kuingia!";
                }
            };
            
            // Subscribing to auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `Mtandaomtumiaji ID: ${userId}`;
                    isAuthReady = true;
                    saveButton.disabled = false;
                    
                    // Anzisha usikilizaji wa data baada ya mtumiaji kuthibitishwa
                    setupFirestoreListener();
                } else {
                    // Ikiwa hakuna mtumiaji, inahitaji kuingia.
                    authenticate();
                }
            });
        } else {
            userIdDisplay.textContent = "Kosa: Config ya Firebase haipatikani.";
        }

        // ------------------------------------------
        // 2. LOGIC YA FIRESTORE (Hifadhi na Rudi)
        // ------------------------------------------
        
        // Hifadhi data ya picha kwenye Firestore
        const saveImageToFirestore = async (base64Image) => {
            if (!isAuthReady || !db || !userId) {
                statusMessage.textContent = "Inasubiri uthibitisho...";
                return;
            }

            const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile_data`, 'user_profile');

            try {
                profileImage.classList.add('profile-photo-loading');
                statusMessage.textContent = "Inahifadhi picha...";

                await setDoc(profileDocRef, {
                    base64Image: base64Image,
                    uploadedAt: new Date().toISOString()
                });
                
                statusMessage.textContent = "Picha imehifadhiwa kwa mafanikio!";
                setTimeout(() => { statusMessage.textContent = ""; }, 3000); // Ondoa ujumbe baada ya muda
                
            } catch (e) {
                console.error("Kosa la kuhifadhi picha: ", e);
                statusMessage.textContent = "Kosa la kuhifadhi: Angalia console.";
            } finally {
                profileImage.classList.remove('profile-photo-loading');
            }
        };

        // Usikilizaji wa Data (Real-time Listener)
        const setupFirestoreListener = () => {
            const profileDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile_data`, 'user_profile');
            
            // Anzisha hali ya upakiaji
            profileImage.classList.add('profile-photo-loading');
            statusMessage.textContent = "Inapakia picha iliyohifadhiwa...";

            // onSnapshot hupakia mara moja na husikiliza mabadiliko
            onSnapshot(profileDocRef, (doc) => {
                profileImage.classList.remove('profile-photo-loading');
                if (doc.exists() && doc.data().base64Image) {
                    const data = doc.data();
                    profileImage.src = data.base64Image;
                    statusMessage.textContent = "Picha imepakiwa kutoka Database.";
                    setTimeout(() => { statusMessage.textContent = ""; }, 3000);
                } else {
                    statusMessage.textContent = "Hakuna picha iliyohifadhiwa.";
                }
            }, (error) => {
                console.error("Kosa la kusikiliza data: ", error);
                statusMessage.textContent = "Kosa la kupakia data ya wasifu.";
            });
        };


        // ------------------------------------------
        // 3. LOGIC YA UPLOAD (Frontend)
        // ------------------------------------------
        
        let selectedFile = null;

        // Kazi ya kuonyesha picha na kuiandaa kwa kuhifadhi
        photoInput.addEventListener('change', function(event) {
            selectedFile = event.target.files[0];
            const reader = new FileReader();

            if (selectedFile) {
                fileNameDisplay.textContent = 'Imechaguliwa: ' + selectedFile.name;
                
                reader.onload = function(e) {
                    // Onyesha picha ya duara papo hapo kwa mtumiaji (Preview)
                    profileImage.src = e.target.result;
                };

                // Soma faili kama Data URL (Base64)
                reader.readAsDataURL(selectedFile);
            } else {
                fileNameDisplay.textContent = "Hakuna picha iliyochaguliwa.";
                selectedFile = null;
            }
        });

        // Kazi ya Kutuma Fomu (Inaita Hifadhi ya Firestore)
        document.getElementById('uploadForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (!selectedFile) {
                alert("Tafadhali chagua picha kwanza.");
                return;
            }
            
            if (selectedFile.size > 500 * 1024) { // Kikomo cha 500KB kwa Base64
                 alert("Faili ni kubwa mno. Tafadhali chagua faili dogo (chini ya 500KB) kwa sababu ya uhifadhi wa Base64.");
                 return;
            }

            const reader = new FileReader();
            
            // Soma faili tena na uitume Base64 kwa Firestore
            reader.onload = function(e) {
                saveImageToFirestore(e.target.result);
            };
            reader.readAsDataURL(selectedFile);
        });

    </script>
</body>
</html>
